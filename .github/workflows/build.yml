name: Build Emerald Legacy ROM

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      DEBIAN_FRONTEND: noninteractive

    steps:
    - name: ðŸ“¥ Checkout repo
      uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: ðŸ” Show runner info
      run: |
        uname -a
        lsb_release -a || true
        which curl || sudo apt-get update -y && sudo apt-get install -y curl

    - name: ðŸ”§ Install base dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          ca-certificates curl gnupg apt-transport-https \
          build-essential libpng-dev python3 wget tar xz-utils

    - name: ðŸ— Add devkitPro APT repo and import GPG key (signed-by)
      run: |
        sudo mkdir -p /etc/apt/keyrings
        curl -fsSL https://apt.devkitpro.org/devkitpro-key.gpg | sudo tee /etc/apt/keyrings/devkitpro.gpg > /dev/null
        echo 'deb [signed-by=/etc/apt/keyrings/devkitpro.gpg] https://apt.devkitpro.org stable main' | sudo tee /etc/apt/sources.list.d/devkitpro.list
        sudo apt-get update

    - name: ðŸ”§ Install devkitpro-pacman and devkitARM
      run: |
        sudo apt-get install -y --no-install-recommends devkitpro-pacman
        # Update pacman DB and install devkitARM non-interactively
        sudo dkp-pacman -Syu --noconfirm
        sudo dkp-pacman -S --noconfirm devkitARM

        # Export devkit environment for subsequent steps
        echo "DEVKITPRO=/opt/devkitpro" >> $GITHUB_ENV
        echo "DEVKITARM=/opt/devkitpro/devkitARM" >> $GITHUB_ENV
        echo "/opt/devkitpro/devkitARM/bin" >> $GITHUB_PATH

    - name: ðŸ”Ž Verify toolchain
      run: |
        echo "DEVKITPRO=$DEVKITPRO"
        echo "DEVKITARM=$DEVKITARM"
        which arm-none-eabi-gcc || true
        arm-none-eabi-gcc --version || true

    - name: ðŸ”¨ Build internal tools
      run: |
        chmod +x build_tools.sh
        ./build_tools.sh

    - name: ðŸ›  Build ROM
      run: |
        make clean
        make -j$(nproc)

    - name: ðŸ“¦ Upload ROM Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Emerald-Legacy-Mew
        path: '*.gba'
