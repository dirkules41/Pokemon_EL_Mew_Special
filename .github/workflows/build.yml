name: Build PokÃ©mon Emerald ROM

on:
  workflow_dispatch:
    inputs:
      baserom:
        description: "Upload your baserom.gba file"
        required: true
        type: file

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    # Base-ROM aus Upload wiederherstellen
    - name: Extract base ROM
      uses: actions/download-artifact@v3
      with:
        name: baserom
        path: .

    - name: Rename base ROM
      run: mv *.gba baserom.gba

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential git automake wget unzip

        # devkitARM installieren (standard devkitPro install script)
        sudo mkdir -p /opt/devkitpro
        sudo chown $USER /opt/devkitpro
        wget https://apt.devkitpro.org/install-devkitpro-pacman
        chmod +x install-devkitpro-pacman
        sudo ./install-devkitpro-pacman

        sudo dkp-pacman -Sy --noconfirm devkitARM general-tools

        export DEVKITPRO=/opt/devkitpro
        export DEVKITARM=/opt/devkitpro/devkitARM
        echo "DEVKITPRO=/opt/devkitpro" >> $GITHUB_ENV
        echo "DEVKITARM=/opt/devkitpro/devkitARM" >> $GITHUB_ENV

    - name: Build ROM
      run: |
        make clean
        make

    - name: Upload built ROM
      uses: actions/upload-artifact@v3
      with:
        name: Built-ROM
        path: "*.gba"
